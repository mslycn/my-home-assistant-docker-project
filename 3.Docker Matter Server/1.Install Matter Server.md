# matter server 

~~~
docker run -d \
    --name matter-server \
    --restart=unless-stopped \
    --security-opt apparmor=unconfined \
    -v $(pwd)/data:/data \
    --network=host \
    ghcr.io/home-assistant-libs/python-matter-server:stable
~~~    

这一步将 Matter Server 容器化应用以后台模式运行，数据挂载至当前目录下的 data 文件夹，确保数据持久化。通过 --network=host 指令使其能直接访问主机网络。



2025.08 run ok

进行添加本地蓝牙配对，添加额外参数来挂载 D-Bus 插槽及明确存储路径
~~~

docker run -d \
  --name matter-server \
  --restart=unless-stopped \
  --security-opt apparmor=unconfined \
  -v /datadocker/matter-server:/data \
  -v /run/dbus:/run/dbus:ro \
  --network=host \
  ghcr.io/home-assistant-libs/python-matter-server:8.0.0 --storage-path /data --paa-root-cert-dir /data/credentials --bluetooth-adapter 0
~~~

1. Matter Server 需绑定宿主机的蓝牙接口（如 -v /run/dbus:/run/dbus:ro）以支持蓝牙 LE 配对
2. 还未连接到目标 IP 网络的设备使用蓝牙 LE作为通道配对。
3. 已经加入IP网络的设备只需要使用IP协议对Matter网络进行配对
4. 设备可以通过蓝牙 LE 加入现有 IP 网络，然后加入 Matter 网络

docker-compose.yml
~~~
services:
  home-assistant:
    container_name: home-assistant
    image: ghcr.io/home-assistant/home-assistant:stable
    hostname: home-assistant
    network_mode: host
    depends_on:
      - zwavejs2mqtt
      - z2m
      - frigate
      - hass_otbr
      - matter-server
    volumes:
      - $DOCKER_CONFS/home-assistant:/config
      - /var/run/docker.sock:/var/run/docker.sock
      - /run/dbus:/run/dbus:ro
    environment:
      - PUID=$PUID
      - PGID=$PGID
      - TZ=$TZ
    restart: unless-stopped
    privileged: true

  hass_otbr:
    container_name: hass_otbr
    image: ghcr.io/ownbee/hass-otbr-docker
    restart: unless-stopped
    privileged: true
    network_mode: host
    cap_add:
      - SYS_ADMIN
      - NET_ADMIN
    environment:
      DEVICE: "/dev/ttyUSB1"
      BACKBONE_IF: enp5s0
      FLOW_CONTROL: 1
      FIREWALL: 1
      NAT64: 1
      BAUDRATE: 460800
      OTBR_REST_PORT: 8081
      OTBR_WEB_PORT: 8080
      AUTOFLASH_FIRMWARE: 0
    devices:
      - /dev/ttyUSB1:/dev/ttyUSB1
    volumes:
      - $DOCKER_CONFS/hass_otbr:/var/lib/thread

  matter-server:
    image: ghcr.io/home-assistant-libs/python-matter-server:stable
    container_name: matter-server
    restart: unless-stopped
    network_mode: host
    privileged: true
    security_opt:
      - apparmor:unconfined
    volumes:
      - $DOCKER_CONFS/matter:/data/
      - /run/dbus:/run/dbus:ro
      - /etc/localtime:/etc/localtime:ro
    devices:
      - /dev/hci0
    command: >
      --storage-path /data
      --paa-root-cert-dir /data/credentials
      --bluetooth-adapter 0
~~~
source:https://community.home-assistant.io/t/ha-docker-with-otbr-docker/735288/7


other
you must add tag with stable
~~~
 docker pull ghcr.io/home-assistant-libs/python-matter-server
Using default tag: latest
Error response from daemon: failed to resolve reference "ghcr.io/home-assistant-libs/python-matter-server:latest": ghcr.io/home-assistant-libs/python-matter-server:latest: not found
~~~

docker exec -it matter-server /bin/bash


From inside container, IPv6 ping is ok.

# docker exec -it matter-server ping6 google.com
PING google.com(pnzrha-af-in-x0e.1e100.net (2a00:1450:400a:805::200e)) 56 data bytes
64 bytes from pnzrha-af-in-x0e.1e100.net (2a00:1450:400a:805::200e): icmp_seq=1 ttl=115 time=6.86 ms


docker logs -f matter-server
~~~
# 服务启动时初始化CHIP/Matter日志系统服务启动时初始化CHIP/Matter日志系统
2025-08-13 15:22:01.667 (MainThread) INFO [matter_server.server.stack] Initializing CHIP/Matter Logging...
2025-08-13 15:22:01.668 (MainThread) INFO [matter_server.server.stack] Initializing CHIP/Matter Controller Stack...
[1755098521.699962][1:1] CHIP:CTL: Setting attestation nonce to random value
[1755098521.700141][1:1] CHIP:CTL: Setting CSR nonce to random value
[1755098521.700789][1:1] CHIP:DL: ChipLinuxStorage::Init: Using KVS config file: /tmp/chip_kvs
[1755098521.700973][1:1] CHIP:DL: ChipLinuxStorage::Init: Using KVS config file: /data/chip_factory.ini
[1755098521.701050][1:1] CHIP:DL: ChipLinuxStorage::Init: Using KVS config file: /data/chip_config.ini
[1755098521.701071][1:1] CHIP:DL: ChipLinuxStorage::Init: Using KVS config file: /data/chip_counters.ini
[1755098521.706713][1:1] CHIP:DL: Wrote settings to /data/chip_counters.ini
[1755098521.706724][1:1] CHIP:DL: NVS set: chip-counters/reboot-count = 49 (0x31)
[1755098521.706951][1:1] CHIP:DL: Got Ethernet interface: eth0
[1755098521.707040][1:1] CHIP:DL: Found the primary Ethernet interface:eth0
[1755098521.707121][1:1] CHIP:DL: Got WiFi interface: wlan0
[1755098521.707134][1:1] CHIP:DL: Failed to reset WiFi statistic counts

# 加载持久化存储配置(/data/chip.json)
2025-08-13 15:22:01.707 (MainThread) INFO [chip.storage] Initializing persistent storage from file: /data/chip.json
2025-08-13 15:22:01.707 (MainThread) INFO [chip.storage] Loading configuration from /data/chip.json...
2025-08-13 15:22:01.785 (MainThread) INFO [chip.CertificateAuthority] Loading certificate authorities from storage...
2025-08-13 15:22:01.785 (MainThread) INFO [chip.CertificateAuthority] New CertificateAuthority at index 1
2025-08-13 15:22:01.786 (MainThread) INFO [chip.CertificateAuthority] Loading fabric admins from storage...
2025-08-13 15:22:01.786 (MainThread) INFO [chip.FabricAdmin] New FabricAdmin: FabricId: 0x0000000000000001, VendorId = 0xFFF1
2025-08-13 15:22:01.786 (MainThread) INFO [matter_server.server.stack] CHIP Controller Stack initialized.
2025-08-13 15:22:01.787 (MainThread) INFO [matter_server.server.server] Starting the Matter Server...

# 从csa官方下载更新当前全部厂家的PAA文件
2025-08-13 15:22:01.789 (MainThread) INFO [matter_server.server.helpers.paa_certificates] Fetching the latest PAA root certificates from DCL.
2025-08-13 15:22:34.093 (MainThread) INFO [matter_server.server.helpers.paa_certificates] Fetched 70 PAA root certificates from DCL.
2025-08-13 15:22:34.093 (MainThread) INFO [matter_server.server.helpers.paa_certificates] Fetching the latest PAA root certificates from Git.
2025-08-13 15:27:38.691 (MainThread) INFO [matter_server.server.helpers.paa_certificates] Fetched 0 PAA root certificates from Git.


2025-08-13 15:27:38.692 (MainThread) INFO [chip.FabricAdmin] Allocating new controller with CaIndex: 1, FabricId: 0x0000000000000001, NodeId: 0x000000000001B669, CatTags: []
2025-08-13 15:27:38.793 (MainThread) INFO [matter_server.server.vendor_info] Loading vendor info from storage.
2025-08-13 15:27:38.797 (MainThread) INFO [matter_server.server.vendor_info] Loaded 340 vendors from storage.
2025-08-13 15:27:38.798 (MainThread) INFO [matter_server.server.vendor_info] Fetching the latest vendor info from DCL.
2025-08-13 15:27:42.711 (MainThread) INFO [matter_server.server.vendor_info] Fetched 340 vendors from DCL.
2025-08-13 15:27:42.711 (MainThread) INFO [matter_server.server.vendor_info] Saving vendor info to storage.

# 加载已配网的matter设备（aqara m1s）
2025-08-13 15:27:42.717 (MainThread) INFO [matter_server.server.device_controller] Loaded 1 nodes from stored configuration
2025-08-13 15:27:42.722 (MainThread) INFO [matter_server.server.server] Matter Server successfully initialized.
2025-08-13 15:27:43.460 (MainThread) INFO [matter_server.server.device_controller.mdns] <Node:1> Discovered on mDNS
2025-08-13 15:27:43.460 (MainThread) INFO [matter_server.server.device_controller] <Node:1> Setting-up node...
2025-08-13 15:27:44.409 (MainThread) INFO [matter_server.server.device_controller] <Node:1> Setting up attributes and events subscription.
2025-08-13 15:27:44.473 (MainThread) INFO [matter_server.server.device_controller.mdns] <Node:1> Discovered on mDNS
# 订阅：subscribe to Node表明设备被识别，建立稳定的数据通信通道。
2025-08-13 15:27:44.928 (MainThread) INFO [matter_server.server.device_controller] <Node:1> Subscription succeeded with report interval [1, 60]


~~~


Matter设备都是经过CSA认证获得签发CD并写入DAC证书的，配网需要用到PAA文件，要给哪个品牌的Matter设备配网就要拿到这个厂家的PAA文件(从csa官方下载更新当前全部厂家的PAA文件)

PAA证书

由CAS联盟认证的根证书颁发机构颁发  是一个自签名证书

PAI由PAA签发    PAA会为产品认证中间机构签发PAI证书  这个证书签发过程是用PAA的私钥为PAI的公钥进行签名

DAC由PAI签发    是由PAI签发,PAI用自己的私钥为设备的公钥签名，产生DAC证书设备生产厂家可以向CSA联盟申请成为PAA证书颁发机构，产生PAA证书，为产品签发PAI证书，也可以
使用CSA联盟认证的第三方PAA证书机构，申请签发PAI证书，PAI证书包含VID和PID ，一款产品可以使用相同的PAI证书来签发DAC证书

NOC证书

NOC （节点操作证书）
1、用来证明设备在该Fabric中的合法性 
2、设备中保存与NOC相对应的私钥

matter设备加入到Fabric后，配网设备（APP\Matter control）会为其颁发NOC证书

