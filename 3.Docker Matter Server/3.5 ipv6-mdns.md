

# 3.3 ipv6-mdns

Verify that your local network infrastructure (router, Wi-Fi access points) is correctly configured to handle IPv6 traffic and allow mDNS (multicast DNS) broadcasts for Matter device discovery.

## wifi router
IGMP Snooping and Multicast DNS are also enabled
IPv6 is enabled

IPv6 DHCP server
there is no IPv6 DHCP server on the network, devices will assign themselves link local addresses that work within the subnet

## Host debain12

You need to have

IPv6 enabled
only one NIC in HA, Matter server and OTBR
HA, Matter, OTBR and phone on the same Network/VLAN


the OTBR be advertising itself using mDNS on my LAN and the mesh network. use macvlan to do this

### Check if the Raspberry Pi Supports mDNS

Make sure the Raspberry Pi is running Avahi or a similar mDNS service. The default Raspberry Pi OS installation includes Avahi. 

~~~
ps aux | grep avahi-daemon
avahi        585  0.0  0.0   8320  3120 ?        Ss   Jul05   9:22 avahi-daemon: running [raspberrypi-7.local]
avahi        606  0.0  0.0   7424  1616 ?        S    Jul05   0:00 avahi-daemon: chroot helper
root     2283102  0.0  0.0   6240  1600 pts/3    S+   05:05   0:00 grep avahi-daemon

~~~


ipmaddr

ip a

ip addr

~~~
1:	lo
	inet  224.0.0.251 users 2
	inet  224.0.0.1
	inet6 ff02::fb users 2
	inet6 ff02::1
	inet6 ff01::1
2:	eth0
	link  01:00:5e:00:00:01
	link  33:33:00:00:00:01
	link  33:33:ff:d1:c8:d4
	link  01:00:5e:00:00:fb
	link  33:33:ff:54:c7:2b
	link  33:33:00:00:00:fb
	link  33:33:ff:00:10:00
	link  33:33:00:00:00:03
	link  33:33:00:00:00:0c
	link  01:00:5e:7f:ff:fa
	inet  239.255.255.250 users 6
	inet  224.0.0.251 users 6
	inet  224.0.0.1
	inet6 ff02::c users 5
	inet6 ff32:40:fd6a:a743:6461:ef1:0:3
	inet6 ff02::1:ff00:1000
	inet6 ff02::fb users 5
	inet6 ff02::1:ff54:c72b
	inet6 ff02::1:ffd1:c8d4
	inet6 ff02::1
	inet6 ff01::1

~~~

Thread network info (_meshcop._udp) 

~~~
avahi-browse -r -t _meshcop._udp
+ veth8af4770 IPv6 Home Assistant OpenThread Border Router #3FF3 _meshcop._udp        local
+ vethaa73af0 IPv6 Home Assistant OpenThread Border Router #3FF3 _meshcop._udp        local
+ vethc8b02d4 IPv6 Home Assistant OpenThread Border Router #3FF3 _meshcop._udp        local
+ br-e9bd32755d40 IPv4 Home Assistant OpenThread Border Router #3FF3 _meshcop._udp        local
+ br-caefea183540 IPv6 Home Assistant OpenThread Border Router #3FF3 _meshcop._udp        local
+ br-caefea183540 IPv4 Home Assistant OpenThread Border Router #3FF3 _meshcop._udp        local
+ br-95fd917067c9 IPv6 Home Assistant OpenThread Border Router #3FF3 _meshcop._udp        local
+ br-95fd917067c9 IPv4 Home Assistant OpenThread Border Router #3FF3 _meshcop._udp        local
+ br-4e4114b168fc IPv6 Home Assistant OpenThread Border Router #3FF3 _meshcop._udp        local
+ br-4e4114b168fc IPv4 Home Assistant OpenThread Border Router #3FF3 _meshcop._udp        local
+ docker0 IPv6 Home Assistant OpenThread Border Router #3FF3 _meshcop._udp        local
+ docker0 IPv4 Home Assistant OpenThread Border Router #3FF3 _meshcop._udp        local
+   eth0 IPv6 ______                                        _meshcop._udp        local
+   eth0 IPv6 Home Assistant OpenThread Border Router #3FF3 _meshcop._udp        local
+   eth0 IPv4 ______                                        _meshcop._udp        local
+   eth0 IPv4 Home Assistant OpenThread Border Router #3FF3 _meshcop._udp        local
= veth8af4770 IPv6 Home Assistant OpenThread Border Router #3FF3 _meshcop._udp        local
   hostname = [raspberrypi.local]
   address = [fe80::e0ab:9eff:fe41:310f]
   port = [49154]


~~~



## Docker

## mDNS/DNS-SD
Home Assistant discovers all Thread border routers in your network because they send mDNS/DNS-SD announcements.

### mdns

Avahi utilities
~~~
avahi-browse -r -t _meshcop._udp
~~~

Detail:

https://openthread.io/guides/border-router/mdns-discovery




_matterd._udp

### DNS-SD

服务发现

There are several ways to discover your Thread network.

### DNS Service Discovery (DNS-SD)
~~~
dns-sd -B _meshcop._udp local
~~~


组件	依赖项	配置重点
Home Assistant	Docker 网络	启用 IPv6，绑定 mDNS 端口
OTBR	Host 网络模式	挂载 Thread 设备，IPv6 转发
mDNS	Avahi 服务	UDP 5353 端口开放
网络接口	桥接或路由	确保同一子网，IPv6 路由通告


| 组件 | 依赖项 | 配置重点 | 配置重点 | First Header | Second Header |
| ------------- | ------------- | ------------- | ------------- | ------------- | ------------- |
| Home Assistant | Docker 网络 | Content Cell | Content Cell | Content Cell | Content Cell |
| OTBR | Host 网络模式 | Content Cell | Content Cell | Content Cell | Content Cell |
| mDNS | Avahi 服务 | Content Cell | Content Cell | Content Cell | Content Cell |
| 网络接口 | 桥接/路由模式 | Content Cell | Content Cell | Content Cell | Content Cell |



| 组件          | hassos| ha docker| 配置重点 | First Header | Second Header |
| ------------- | ------------- | ------------- | ------------- | ------------- | ------------- |
| /etc/hosts| 127.0.0.1	localhost
::1	localhost ip6-localhost ip6-loopback
fe00::	ip6-localnet
ff00::	ip6-mcastprefix
ff02::1	ip6-allnodes
ff02::2	ip6-allrouters
172.30.32.2	hassio
172.30.32.2	supervisor | Content Cell | Content Cell | Content Cell | Content Cell |
| OTBR | Host 网络模式 | Content Cell | Content Cell | Content Cell | Content Cell |
| mDNS | Avahi 服务 | Content Cell | Content Cell | Content Cell | Content Cell |
| 网络接口 | 桥接/路由模式 | Content Cell | Content Cell | Content Cell | Content Cell |



## router




## Host - 网络配置

检测有哪些网卡（物理网卡+虚拟网卡）

docker network ls   （hassos）

~~~
NETWORK ID     NAME      DRIVER    SCOPE
012506a27536   bridge    bridge    local
04f9dd4db3c4   hassio    bridge    local
c2f07efe8983   host      host      local
074e19c5d2ef   none      null      local
~~~





## Host - Enable IP forwarding
~~~
echo 'net.ipv4.ip_forward = 1' | sudo tee -a /etc/sysctl.conf
echo 'net.ipv6.conf.all.forwarding = 1' | sudo tee -a /etc/sysctl.conf
sudo sysctl -p /etc/sysctl.conf

~~~

With NAT64 enabled connected Thread devices should be able to resolve IPv4 addresses.


## mdns - host
ping -6 raspberrypi.local

ping raspberrypi.local


Discovering Your Matter Devices with mDNS


## mdns - router
ping6 raspberrypi.local

ping raspberrypi.local



Border Router services

OTBR provides the following services:

mDNS Publisher — Allows an External Commissioner to discover an OTBR and its associated Thread network
PSKc Generator — For generation of PSKc keys

OTBR firewall

OTBR uses iptables and ipset to implement the following ingress filtering rules:

Block inbound packets initiated with On-Link address sources, for example Off-Mesh Routable (OMR) and Mesh-Local prefix based addresses.
Block inbound unicast packets whose destination address is not an OMR address or a Domain Unicast Address (DUA).
Block inbound unicast packets whose source address or destination address is Link-Local. Note that this rule is handled by the kernel and not explicitly set.

https://openthread.io/guides/border-router



## Checklist

https://community.home-assistant.io/t/running-otbr-in-docker/835125/4




1. 总

https://www.oryoy.com/news/ru-he-zai-docker-zhong-pei-zhi-he-qi-yong-ipv6-zhi-chi-yi-jie-jue-host-ipv6-yi-jin-yong-wen-ti.html

2. 路由器开通ipv6


2. 宿主机开通ipv6




2. 容器使用的网络开启ipv6

https://blog.hellowood.dev/posts/linux-docker%E5%AE%B9%E5%99%A8%E5%BC%80%E5%90%AFipv6/

2. docker 容器内部开通ipv6

